name: Spring Boot CI/CD with dynamic .env

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      # Step untuk decode dan simpan firebase-admin-sdk.json dari secret base64
      - name: Decode Firebase Admin SDK JSON
        run: |
          echo "${{ secrets.FIREBASE_ADMIN_SDK_BASE64 }}" | base64 -d > src/main/resources/firebase-admin-sdk.json

      # (Optional) buat .env file dari secrets (kalau dibutuhkan)
      #      - name: Create .env file from GitHub Secrets
      #        run: |
      #          echo "Creating .env file from secrets..."
      #          cat <<EOF > .env
      #          SPRING_APPLICATION_NAME=${{ secrets.SPRING_APPLICATION_NAME }}
      #          ...
      #          EOF

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Copy JAR to GCP VM
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "target/*.jar"
          target: "/home/${{ secrets.VM_USER }}/fintara-dev"

#      - name: Copy .env to GCP VM
#        uses: appleboy/scp-action@v0.1.4
#        with:
#          host: ${{ secrets.VM_HOST }}
#          username: ${{ secrets.VM_USER }}
#          key: ${{ secrets.SSH_PRIVATE_KEY }}
#          source: ".env"
#          target: "/home/${{ secrets.VM_USER }}/fintara-dev"

#      - name: Run tests
#        run: ./mvnw test
#
#      - name: Run Spring Boot application
#        run: |
#          export $(grep -v '^#' .env | xargs)
#          java -jar target/*.jar
